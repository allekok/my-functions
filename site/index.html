<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width">
		<title>My Functions</title>
		<style>
		 @font-face {
			 font-family:"SourceCodeProBold";
			 font-display:swap;
			 src:url("./font/SourceCodePro-Bold.woff2")
			 format("woff2");
		 }
		 @font-face {
			 font-family:"DroidNaskhRegular";
			 font-display:swap;
			 src:url("./font/DroidNaskh-Regular.woff2")
			 format("woff2");
			 unicode-range:U+0600-06FF;
		 }
		 @font-face {
			 font-family:"MaterialIcons";
			 font-display:swap;
			 src:url("./font/Material-Icons.woff2")
			 format("woff2");
		 }
		 html {
			 height:100%;
		 }
		 body {
			 margin:0;
			 height:100%;
			 font-family:"DroidNaskhRegular","SourceCodeProBold",
			 monospace;
			 font-size:14px;
			 background:#fff;
			 color:#000;
			 font-weight:bold;
		 }
		 #shell {
			 display:flex;
			 flex-direction:column;
			 height:100%;
			 white-space:pre-wrap;
		 }
		 #result {
			 height:100%;
			 overflow:auto;
			 word-break:break-word;
		 }
		 #result p {
			 margin:0;
			 padding:.5em;
			 border-top:1px solid
		 }
		 #input {
			 -webkit-appearance:none;
			 outline:0;
			 border-radius:0;
			 box-shadow:none;
			 border:0;
			 background:none;
			 color:inherit;
			 border-top:1px solid;
			 padding:.5em;
			 font-family:inherit;
			 font-size:1.1em;
			 font-weight:inherit;
			 max-width:100%;
			 width:100%;
			 height:100%;
			 box-sizing:border-box;
		 }
		 #input:focus {
			 border:0;
			 box-shadow:none;
			 border-top:2px solid;
		 }
		 #inputDiv {
			 display:flex;
			 width:100%;
			 height:11em;
		 }
		 #execBtn {
			 box-sizing:border-box;
			 min-width:15%;
			 background:#000;
			 color:#fff;
			 height:100%;
			 border:0;
			 outline:0;
			 padding:.5em;
			 font-size:1.1em;
			 font-family:inherit;
		 }
		 .c {
			 color:#00e;
		 }
		 .e {
			 color:#e00;
		 }
		 .rtl {
			 display:inline-block;
			 direction:rtl;
		 }
		</style>
	</head>
	<body>
		<div id="shell">
			<div id="result"></div>
			<div id="inputDiv">
				<textarea id="input" placeholder=">"></textarea>
				<button type="button" id="execBtn">&gt;&gt;</button>
			</div>
		</div>

		<script src="../src/my-library-functions.js"></script>
		<script src="../src/my-library.js" defer></script>
		<script>
		 /* Globals */
		 const input = document.querySelector('#input')
		 const result = document.querySelector('#result')
		 const execBtn = document.querySelector('#execBtn')
		 let history = ['']
		 let history_pointer = 0
		 let nth = 0
		 
		 /* Run */
		 init_result()

		 /* Events */
		 input.addEventListener('keyup', key_dispatch)
		 execBtn.addEventListener('click', () => {
			 execute()
			 input.focus()
		 })

		 /* Functions */
		 function key_dispatch(e) {
			 if(e.ctrlKey && e.key == 'Enter')
				 execute()
			 else if(e.ctrlKey && e.key == 'ArrowDown') {
				 if(history_pointer < (history.length - 1))
					 input.value = history[++history_pointer]
			 }
			 else if(e.ctrlKey && e.key == 'ArrowUp') {
				 if(history_pointer > 0)
					 input.value = history[--history_pointer]
			 }
		 }
		 function execute() {
			 const v = input.value.trim()
			 if(v && (v !== history[history.length-1])) {
				 history.push(v)
				 history_pointer = history.length-1
			 }

			 try {
				 append_to_result(input.value + '\n<span class="c">=></span> ' +
						  to_string(eval(input.value)))
			 }
			 catch (e) {
				 append_to_result(input.value + '\n<span class="e">=></span> ' + e)
			 }
		 }
		 function to_string(x, level=0) {
			 if(x === null)
				 return x
			 else if(typeof(x) != 'object') {
				 if(x === undefined)
					 return x
				 else if(typeof(x) == 'boolean')
					 return x
				 else if(typeof(x) == 'number')
					 return x
				 else if(typeof(x) == 'bigint')
					 return x
				 else if(typeof(x) == 'symbol')
					 return x
				 else if(typeof(x) == 'string') 
					 return `'${x}'`
				 else if(typeof(x) == 'function')
					 return x.toString()
				 else
					 return x
			 }
			 else if(Array.isArray(x)) {
				 let str = '['
				 for(const o of x)
					 str += to_string(o, level) + ','
				 str = str.substr(0, str.length-1) + ']'
				 return str
			 }
			 else if(typeof(x) == 'object') {
				 const tab = '\t'.repeat(level)
				 let str = '{\n'
				 for(let k in x) {
					 let v = to_string(x[k], level+1)
					 k = to_string(k, level)
					 str += `${tab}\t${k}:${v},\n`
				 }
				 str = str.substr(0, str.length-2) + '\n' + tab + '}'
				 return str
			 }
			 else
				 return x
		 }
		 function clear() {
			 let i = 0
			 result.innerHTML = ''
			 append_to_result('\n[Ctrl+Enter]: Execution\n[Ctrl+Up]: Going backward in history\n[Ctrl+Down]: Going foreward in history\n[Finding a function]: "$(\'a subset of function\'s prototype\')"\n[Clear screen]: clear()')
			 append_to_result(`Functions[${my_library_functions.length}]:\n` +
					  my_library_functions.map(o=>`|${i++}| ${o}`).join('\n'))
			 result.scrollTo(0,0)
			 input.focus()
		 }
		 function init_result() {
			 clear()
		 }
		 function append_to_result(str) {
			 result.innerHTML += `<p>[${nth}] ${str}</p>`
			 result.scrollTo(0, result.scrollHeight)
			 nth++
		 }
		 function display(str) {
			 append_to_result(to_string(str))
		 }
		</script>
	</body>
</html>
